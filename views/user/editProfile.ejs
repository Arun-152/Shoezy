<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/editProfile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%- include("../partials/user/navbar") %>

    <!-- Main Layout Container -->
    <div class="page-container">
        <!-- Main Layout with Sidebar -->
        <div class="page-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <%- include("../partials/user/profileSidebar") %>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <div class="container">
                    <div class="page-header">
                        <div class="header-icon">
                            <span class="material-icons">edit</span>
                        </div>
                        <div class="header-text">
                            <h1>Edit Profile</h1>
                            <p>Update your personal information and profile picture</p>
                        </div>
                    </div>

                    <div class="profile-section">
                        <!-- Profile Picture Section -->
                        <div class="profile-pic-section">
                            <div class="section-header">
                                <div class="section-title">
                                    <h2>Profile Picture</h2>
                                    <p>Click on the image to update your profile picture</p>
                                </div>
                            </div>
                            
                            <div class="profile-pic-container">
                                <div class="profile-pic" onclick="triggerFileUpload()"
                                     style="background-image: url('<%= user.profilePicture ? user.profilePicture + '?t=' + Date.now() : '' %>');">
                                    <% if (!user.profilePicture) { %>
                                        <%= user.fullname.charAt(0).toUpperCase() %>
                                    <% } %>
                                    <div class="camera-overlay">
                                        <span class="material-icons">camera_alt</span>
                                    </div>
                                </div>
                                <input type="file" id="profilePicInput" accept=".jpg,.jpeg,.png,.gif,.webp"
                                    style="display: none;" onchange="handleFileUpload(event)">
                            </div>
                            <div class="pic-info">
                                <p class="pic-instruction">Maximum file size: 5MB</p>
                                <p class="pic-formats">Supported formats: JPEG, PNG, GIF, WebP</p>
                            </div>
                        </div>

                        <!-- Personal Information Section -->
                        <div class="personal-info-section">
                            <div class="section-header">
                                <div class="section-title">
                                    <h2>Personal Information</h2>
                                    <p>Update your basic profile details</p>
                                </div>
                            </div>
                            
                            <div class="info-card">
                                <form id="profileForm" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label for="fullName">
                                            <span class="material-icons">person</span>
                                            Full Name *
                                        </label>
                                        <input type="text" id="fullName" name="fullName" value="<%= user.fullname %>" 
                                               placeholder="Enter your full name">
                                        <div id="fullName-error" class="validationError" style="display: none;"></div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="phoneNumber">
                                            <span class="material-icons">phone</span>
                                            Phone Number *
                                        </label>
                                        <input type="text" id="phoneNumber" name="phoneNumber" value="<%= user.phone %>"
                                               placeholder="Enter your phone number">
                                        <div id="phoneNumber-error" class="validationError" style="display: none;"></div>
                                    </div>
                                    
                                    <!-- Hidden file input for form submission -->
                                    <input type="file" id="profilePictureFile" name="profilePicture" 
                                           accept=".jpg,.jpeg,.png,.gif,.webp" style="display: none;">
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="cancelChanges()">
                                            <span class="material-icons">close</span>
                                            Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <span class="material-icons">save</span>
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <%- include("../partials/user/userfooter") %>

    <script>
        function triggerFileUpload() {
            document.getElementById('profilePicInput').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'File size must be less than 5MB'
                    });
                    event.target.value = ''; // Clear the input
                    return;
                }

                // Check file type
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File Type',
                        text: 'Supported formats: JPEG, PNG, GIF, WebP'
                    });
                    event.target.value = ''; // Clear the input
                    return;
                }

                // Sync the file to the hidden form input
                const formFileInput = document.getElementById('profilePictureFile');
                const dt = new DataTransfer();
                dt.items.add(file);
                formFileInput.files = dt.files;

                // Create preview
                const reader = new FileReader();
                reader.onload = function (e) {
                    const profilePic = document.querySelector('.profile-pic');
                    profilePic.style.backgroundImage = `url(${e.target.result})`;
                    profilePic.style.backgroundSize = 'cover';
                    profilePic.style.backgroundPosition = 'center';
                    profilePic.textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function cancelChanges() {
            Swal.fire({
                title: 'Are you sure?',
                text: 'Any unsaved changes will be lost.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, cancel',
                cancelButtonText: 'No, keep editing'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/profile';
                }
            });
        }

        // Clear form errors
        function clearFormErrors() {
            document.getElementById('fullName-error').style.display = 'none';
            document.getElementById('phoneNumber-error').style.display = 'none';
        }

        // Show form error
        function showFormError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const fullName = document.getElementById('fullName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const formFileInput = document.getElementById('profilePictureFile');
            const file = formFileInput.files[0];

            // Clear previous errors
            clearFormErrors();

            // Client-side validation
            let hasErrors = false;

            if (!fullName) {
                showFormError('fullName-error', 'Full name is required');
                hasErrors = true;
            } else if (fullName.length < 3) {
                showFormError('fullName-error', 'Full name must be at least 3 characters');
                hasErrors = true;
            }
            
            if(!phoneNumber){
                showFormError('phoneNumber-error', 'Phone number is required');
                hasErrors = true;
            }

            if (phoneNumber && (!/^\d{10}$/.test(phoneNumber) || !/^[789]\d{9}$/.test(phoneNumber))) {
                showFormError('phoneNumber-error', 'Phone number must be a valid 10-digit Indian number starting with 7, 8, or 9');
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            const formData = new FormData();
            formData.append('fullName', fullName);
            formData.append('phoneNumber', phoneNumber);
            if (file) {
                formData.append('profilePicture', file);
            }

            try {
                const response = await fetch('/profile/updateProfile', {
                    method: 'PATCH',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: result.message
                    }).then(() => {
                        window.location.href = '/profile';
                    });
                } else {
                    // Show backend validation errors inline
                    if (result.message.includes('Full name')) {
                        showFormError('fullName-error', result.message);
                    } else if (result.message.includes('Phone number')) {
                        showFormError('phoneNumber-error', result.message);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message || 'Something went wrong.'
                        });
                    }
                }
            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: 'Unable to update profile. Please try again.'
                });
            }
        });
    </script>
</body>
</html>
