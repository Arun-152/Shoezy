<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Shoezy</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/orderPage.css">
    <link rel="stylesheet" href="/css/breadcrumbs.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%- include("../partials/user/navbar") %>

    <!-- Main Layout Container -->
    <div class="page-container">
        <!-- Main Layout with Sidebar -->
        <div class="page-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <%- include("../partials/user/profileSidebar") %>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <div class="container">
                    <div class="page-header">
                        <div class="header-icon">
                            <span class="material-icons">shopping_bag</span>
                        </div>
                        <div class="header-text">
                            <h1>My Orders</h1>
                            <p>Track and manage your orders</p>
                        </div>
                    </div>

                    <div class="orders-section">
                        <div class="section-header">
                            <div class="section-title">
                                <h2>Order History</h2>
                                <p>View all your placed orders</p>
                            </div>
                            <!-- Order Filters -->
                            <div class="order-filters">
                                <button class="filter-btn active" data-filter="all">All Orders</button>
                                <button class="filter-btn" data-filter="pending">Pending</button>
                                <button class="filter-btn" data-filter="shipped">Shipped</button>
                                <button class="filter-btn" data-filter="delivered">Delivered</button>
                                <button class="filter-btn" data-filter="cancelled">Cancelled</button>
                            </div>
                        </div>

                        <!-- Orders List -->
                        <div class="orders-list">
                            <% if (orders && orders.length > 0) { %>
                                <% orders.forEach(order => { %>
                                    <div class="order-card" data-status="<%= order.orderStatus.toLowerCase() %>">
                                        <div class="order-header">
                                            <div class="order-info">
                                                <h3>Order #<%= order.orderNumber %></h3>
                                                <p class="order-date">Placed on <%= new Date(order.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
                                            </div>
                                            <div class="order-status <%= order.orderStatus.toLowerCase() %>">
                                                <span class="status-badge"><%= order.orderStatus %></span>
                                            </div>
                                        </div>
                                        <div class="order-items">
                                            <% order.items.slice(0, 2).forEach(item => { %>
                                                <div class="order-item">
                                                    <img src="<%= item.productId.images && item.productId.images.length > 0 ? item.productId.images[0] : 'https://via.placeholder.com/80x80/ffffff/cccccc?text=Shoe' %>" alt="<%= item.productId.productName %>">
                                                    <div class="item-details">
                                                        <h4><%= item.productId.productName %></h4>
                                                        <p class="item-price">Price: ₹<%= item.price.toLocaleString() %></p>
                                                    </div>
                                                    <div class="item-quantity">Qty: <%= item.quantity %></div>
                                                </div>
                                            <% }); %>
                                            <% if (order.items.length > 2) { %>
                                                <p class="more-items">+ <%= order.items.length - 2 %> more item(s)</p>
                                            <% } %>
                                        </div>
                                        <div class="order-footer">
                                            <div class="order-total">
                                                <strong>Total: ₹<%= order.totalAmount.toLocaleString() %></strong>
                                            </div>
                                            <div class="order-actions">
                                                <a href="/order/<%= order._id %>" class="btn btn-secondary">View Details</a>
                                                <% if (order.orderStatus === 'Pending') { %>
                                                    <button class="btn btn-danger" onclick="cancelOrder('<%= order._id %>')">Cancel Order</button>
                                                <% } else if (order.orderStatus === 'Delivered') { %>
                                                    <button class="btn btn-primary">Return</button>
                                                <% } else { %>
                                                    <button class="btn btn-secondary">Track Order</button>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <!-- Empty State -->
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <span class="material-icons">shopping_bag</span>
                                    </div>
                                    <h3>No orders found</h3>
                                    <p>You haven't placed any orders yet. Start shopping to see your orders here!</p>
                                    <a href="/shop" class="btn btn-large btn-primary">Start Shopping</a>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <%- include("../partials/user/userfooter") %>

    <script>
        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Get filter value
                const filter = this.dataset.filter;
                
                // Show/hide orders based on filter
                document.querySelectorAll('.order-card').forEach(card => {
                    if (filter === 'all' || card.dataset.status === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // Check if any orders are visible
                const visibleOrders = document.querySelectorAll('.order-card[style="display: block;"], .order-card:not([style])').length;
                const emptyState = document.querySelector('.empty-state');
                
                if (visibleOrders === 0 && filter !== 'all') {
                    if (emptyState) emptyState.style.display = 'block';
                } else {
                    if (emptyState) emptyState.style.display = 'none';
                }
            });
        });

        // Cancel order functionality
        async function cancelOrder(orderId) {
            try {
                const result = await Swal.fire({
                    title: 'Cancel Order?',
                    text: 'Are you sure you want to cancel this order? This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, cancel order',
                    cancelButtonText: 'No, keep order'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/order/${orderId}/cancel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            title: 'Order Cancelled!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonColor: '#2563eb'
                        }).then(() => {
                            // Reload the page to show updated status
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: data.message || 'Failed to cancel order',
                            icon: 'error',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                }
            } catch (error) {
                console.error('Cancel order error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Something went wrong. Please try again.',
                    icon: 'error',
                    confirmButtonColor: '#dc2626'
                });
            }
        }
    </script>
</body>
</html>
