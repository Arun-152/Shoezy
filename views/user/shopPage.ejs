<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoezy - Premium Footwear Store</title>
    <link rel="stylesheet" href="/css/shopPage.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Enhanced Navbar with Perfect Badge Alignment -->
    <%- include('../partials/user/navbar') %>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <div class="hero-text">
                <h1>Step Into Style</h1>
                <p>Discover our premium collection of footwear designed for comfort and elegance</p>
                <button class="hero-cta-btn" onclick="document.getElementById('shop').scrollIntoView({behavior: 'smooth'})">
                    <i class="fas fa-shopping-bag"></i>
                    Shop Collection
                </button>
            </div>
        </div>
    </section>

    <!-- Main Shop Section -->
    <section class="main-shop-section" id="shop">
        <div class="shop-container">
            <!-- Sidebar Filters -->
            <aside class="filters-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    <button class="clear-all-btn" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        Clear All
                    </button>
                </div>

                <!-- Search Filter -->
                <div class="filter-section">
                    <h4><i class="fas fa-search"></i> Search Products</h4>
                    <div class="search-input-wrapper">
                        <input type="text" id="searchInput" placeholder="Search products..." autocomplete="off">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="filter-section">
                    <h4><i class="fas fa-tags"></i> Category</h4>
                    <select id="category" onchange="filterProducts()">
                        <option value="">All Categories</option>
                        <% if (categories && categories.length > 0) { %>
                            <% categories.forEach(category => { %>
                                <option value="<%= category._id %>">
                                    <%= category.name %>
                                </option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>

                <!-- Price Range Filter -->
                <div class="filter-section">
                    <h4><i class="fas fa-rupee-sign"></i> Price Range</h4>
                    <div class="price-inputs">
                        <input type="number" id="minPrice" placeholder="Min" onchange="filterProducts()">
                        <span class="price-separator">to</span>
                        <input type="number" id="maxPrice" placeholder="Max" onchange="filterProducts()">
                    </div>
                </div>

                <!-- Sort Filter -->
                <div class="filter-section">
                    <h4><i class="fas fa-sort"></i> Sort By</h4>
                    <select id="sortBy" onchange="sortProducts()">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="price-asc">Price (Low to High)</option>
                        <option value="price-desc">Price (High to Low)</option>
                    </select>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="products-main">
                <div class="products-header">
                    <h2>Our Collections</h2>
                </div>

                <!-- Products Grid -->
                <div class="products-grid" id="productsGrid">
                    <% if (products && products.length > 0) { %>
                        <% products.forEach((product, index) => { %>
                            <% 
                            let minPrice = 0;
                            let maxPrice = 0;
                            let totalQuantity = 0;

                            if (product.variants && product.variants.length > 0) {
                                const prices = product.variants.map(v => v.salePrice);
                                minPrice = Math.min(...prices);
                                maxPrice = Math.max(...prices);
                                totalQuantity = product.variants.reduce((sum, v) => sum + v.variantQuantity, 0);
                            }
                            %>
                            <div class="product-card modern" data-id="<%= product._id %>"
                                data-name="<%= product.productName %>"
                                data-price="<%= minPrice %>"
                                data-original-price="<%= product.variants && product.variants.length > 0 ? Math.min(...product.variants.map(v => v.variantPrice)) : 0 %>"
                                data-sale-price="<%= minPrice %>"
                                data-category="<%= product.category ? product.category._id : '' %>"
                                data-category-name="<%= product.category ? product.category.name : 'Uncategorized' %>"
                                data-image="<%= product.images && product.images.length > 0 ? product.images[0] : 'https://images.unsplash.com/photo-1549298916-b41d501d3772?w=300&h=200&fit=crop' %>"
                                data-description="<%= product.description || '' %>"
                                data-quantity="<%= totalQuantity %>"
                                data-status="<%= product.status || 'Available' %>"
                                data-brand="<%= product.brand || '' %>"
                                data-color="<%= product.color || '' %>"
                                data-product-offer="<%= product.productOffer || 0 %>"
                                data-rating="<%= product.ratings && product.ratings.average ? product.ratings.average : 4.5 %>"
                                data-rating-count="<%= product.ratings && product.ratings.count ? product.ratings.count : 0 %>"
                                onclick="<%= typeof user !== 'undefined' && user ? `window.location.href='/product/${product._id}'` : 'redirectToLogin()' %>" 
                                style="cursor: pointer;">

                                <div class="product-image-container">
                                    <div class="product-image">
                                        <% if (product.images && product.images.length > 0) { %>
                                            <img src="<%= product.images[0] %>" alt="<%= product.productName %>">
                                        <% } else { %>
                                            <img src="https://via.placeholder.com/280x280/f8f9fa/dee2e6?text=No+Image" alt="<%= product.productName %>">
                                        <% } %>
                                    </div>

                                    <!-- Badges -->
                                    <% if (product.productOffer && product.productOffer > 0) { %>
                                        <div class="offer-badge">
                                            <%= product.productOffer %>% OFF
                                        </div>
                                    <% } %>

                                    <div class="stock-badge <%= product.status === 'Available' || totalQuantity > 0 ? 'in-stock' : 'out-of-stock' %>">
                                        <%= product.status === 'Available' || totalQuantity > 0 ? 'Available' : 'Out of Stock' %>
                                    </div>

                                    <!-- Wishlist -->
                                    <div class="wishlist-btn" onclick="event.stopPropagation(); toggleWishlist('<%= product._id %>', this)" data-product-id="<%= product._id %>">
                                        <i class="far fa-heart"></i>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="quick-actions">
                                        <% if (product.status !== 'out of stock' && totalQuantity > 0) { %>
                                            <button class="quick-action-btn" onclick="event.stopPropagation(); addToCart('<%= product._id %>')" title="Add to Cart">
                                                <i class="fas fa-shopping-cart"></i>
                                            </button>
                                        <% } %>
                                        <% if (typeof user !== 'undefined' && user) { %>
                                            <button class="quick-action-btn" onclick="event.stopPropagation(); window.location.href='/product/<%= product._id %>'" title="Quick View">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        <% } %>
                                    </div>
                                </div>

                                <div class="product-info">
                                    <h3 class="product-name"><%= product.productName %></h3>
                                    <p class="product-category"><%= product.category ? product.category.name : 'Uncategorized' %></p>
                                    
                                    <div class="product-rating">
                                        <div class="stars">
                                            <% if (product.ratings && product.ratings.average > 0) { %>
                                                <% const rating = product.ratings.average; %>
                                                <% for (let i = 1; i <= 5; i++) { %>
                                                    <% if (i <= Math.floor(rating)) { %>
                                                        <i class="fas fa-star"></i>
                                                    <% } else if (i - 0.5 <= rating) { %>
                                                        <i class="fas fa-star-half-alt"></i>
                                                    <% } else { %>
                                                        <i class="far fa-star"></i>
                                                    <% } %>
                                                <% } %>
                                            <% } else { %>
                                                <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
                                            <% } %>
                                        </div>
                                        <span class="rating-text">(<%= product.ratings && product.ratings.count ? product.ratings.count : 0 %>)</span>
                                    </div>

                                    <div class="product-price">
                                        <% if (product.variants && product.variants.length > 0) { %>
                                            <%
                                                const prices = product.variants.map(v => v.salePrice);
                                                const originalPrices = product.variants.map(v => v.variantPrice);
                                                const minSalePrice = Math.min(...prices);
                                                const minOriginalPrice = Math.min(...originalPrices);
                                                const hasDiscount = minSalePrice < minOriginalPrice;
                                            %>
                                            <span class="current-price">₹<%= minSalePrice %></span>
                                            <% if (hasDiscount) { %>
                                                <span class="original-price">₹<%= minOriginalPrice %></span>
                                            <% } %>
                                        <% } else { %>
                                            <span class="current-price">Price not available</span>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-products">
                            <i class="fas fa-search"></i>
                            <h3>No products found</h3>
                            <p>Try adjusting your filters or check back later.</p>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </section>

    <!-- Why Choose Us Section -->
    <section class="why-choose-us">
        <div class="container">
            <h2 class="section-title">Why Choose Us</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="feature-content">
                        <h3>Free Shipping</h3>
                        <p>Enjoy free shipping on all orders over ₹100. Fast and reliable delivery to your doorstep.</p>
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="feature-content">
                        <h3>Secure Payment</h3>
                        <p>Your transactions are protected with bank-level security and encrypted payment processing.</p>
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                    <div class="feature-content">
                        <h3>Easy Returns</h3>
                        <p>30-day hassle-free returns. Not satisfied? Send it back for a full refund.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <%- include("../partials/user/userfooter") %>

    <!-- Enhanced JavaScript with Fixed Badge Counting -->
    <script>
        // Enhanced Persistent Storage Helper
        class PersistentStorage {
            static getWishlist() {
                try {
                    const wishlist = localStorage.getItem('shoezy_wishlist');
                    return wishlist ? JSON.parse(wishlist) : [];
                } catch (error) {
                    console.error('Error getting wishlist:', error);
                    return [];
                }
            }

            static setWishlist(wishlist) {
                try {
                    localStorage.setItem('shoezy_wishlist', JSON.stringify(wishlist));
                } catch (error) {
                    console.error('Error setting wishlist:', error);
                }
            }

            static addToWishlist(productId) {
                const wishlist = this.getWishlist();
                if (!wishlist.includes(productId)) {
                    wishlist.push(productId);
                    this.setWishlist(wishlist);
                    return true;
                }
                return false;
            }

            static removeFromWishlist(productId) {
                const wishlist = this.getWishlist();
                const index = wishlist.indexOf(productId);
                if (index > -1) {
                    wishlist.splice(index, 1);
                    this.setWishlist(wishlist);
                    return true;
                }
                return false;
            }

            static isInWishlist(productId) {
                return this.getWishlist().includes(productId);
            }

            static getCartCount() {
                try {
                    return parseInt(localStorage.getItem('shoezy_cart_count')) || 0;
                } catch (error) {
                    console.error('Error getting cart count:', error);
                    return 0;
                }
            }

            static setCartCount(count) {
                try {
                    const validCount = Math.max(0, parseInt(count) || 0);
                    localStorage.setItem('shoezy_cart_count', validCount.toString());
                } catch (error) {
                    console.error('Error setting cart count:', error);
                }
            }

            static getWishlistCount() {
                return this.getWishlist().length;
            }

            static setWishlistCount(count) {
                try {
                    localStorage.setItem('shoezy_wishlist_count', count.toString());
                } catch (error) {
                    console.error('Error setting wishlist count:', error);
                }
            }
        }

        // Enhanced Navbar Counter Manager - FIXED
        class NavbarCounters {
            static updateCartCount(newCount) {
                const count = Math.max(0, parseInt(newCount) || 0);
                PersistentStorage.setCartCount(count);
                
                const cartSelectors = ['#cartCount', '.cart-count', '[data-cart-count]'];
                cartSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(elem => {
                        if (elem) {
                            elem.textContent = count;
                            if (count > 0) {
                                elem.style.display = 'flex';
                                elem.style.visibility = 'visible';
                                elem.style.opacity = '1';
                                elem.removeAttribute('data-count');
                            } else {
                                elem.style.display = 'none';
                                elem.style.visibility = 'hidden';
                                elem.style.opacity = '0';
                                elem.setAttribute('data-count', '0');
                            }
                        }
                    });
                });

                if (count > 0) {
                    const cartIcons = document.querySelectorAll('.cart-icon, .cart-btn');
                    cartIcons.forEach(icon => {
                        if (icon) {
                            icon.style.animation = 'cartBounce 0.5s ease';
                            setTimeout(() => { icon.style.animation = ''; }, 500);
                        }
                    });
                }
            }

            static updateWishlistCount(newCount) {
                const count = newCount !== undefined ? Math.max(0, parseInt(newCount) || 0) : PersistentStorage.getWishlistCount();
                PersistentStorage.setWishlistCount(count);
                
                const wishlistSelectors = ['#wishlistCount', '.wishlist-count', '[data-wishlist-count]'];
                wishlistSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(elem => {
                        if (elem) {
                            elem.textContent = count;
                            if (count > 0) {
                                elem.style.display = 'flex';
                                elem.style.visibility = 'visible';
                                elem.style.opacity = '1';
                                elem.removeAttribute('data-count');
                            } else {
                                elem.style.display = 'none';
                                elem.style.visibility = 'hidden';
                                elem.style.opacity = '0';
                                elem.setAttribute('data-count', '0');
                            }
                        }
                    });
                });
            }

            static init() {
                this.updateCartCount(PersistentStorage.getCartCount());
                this.updateWishlistCount(PersistentStorage.getWishlistCount());
            }
        }

        function initializeWishlistStates() {
            const wishlistButtons = document.querySelectorAll('.wishlist-btn');
            wishlistButtons.forEach(btn => {
                const productId = btn.getAttribute('data-product-id');
                const heartIcon = btn.querySelector('i');
                
                if (PersistentStorage.isInWishlist(productId)) {
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas');
                    heartIcon.style.color = '#ff4757';
                } else {
                    heartIcon.classList.remove('fas');
                    heartIcon.classList.add('far');
                    heartIcon.style.color = '';
                }
            });

            const wishlistCount = PersistentStorage.getWishlist().length;
            NavbarCounters.updateWishlistCount(wishlistCount);
        }

        const allProductCards = document.querySelectorAll('.product-card');

        function filterProducts() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            const category = document.getElementById('category').value;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            let visibleCount = 0;

            allProductCards.forEach(card => {
                const productName = card.dataset.name.toLowerCase();
                const productCategory = card.dataset.category;
                const productPrice = parseFloat(card.dataset.price) || 0;

                const matchesSearch = !searchQuery || productName.includes(searchQuery);
                const matchesCategory = !category || productCategory === category;
                const matchesPrice = productPrice >= minPrice && productPrice <= maxPrice;

                if (matchesSearch && matchesCategory && matchesPrice) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            showNoResultsMessage(searchQuery, visibleCount);
            updateFilterHighlighting();
        }

        function sortProducts() {
            const sortBy = document.getElementById('sortBy').value;
            const grid = document.getElementById('productsGrid');
            const productCards = Array.from(grid.querySelectorAll('.product-card:not([style*="display: none"])'));

            productCards.sort((a, b) => {
                switch (sortBy) {
                    case 'name-asc':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    case 'name-desc':
                        return b.dataset.name.localeCompare(a.dataset.name);
                    case 'price-asc':
                        return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
                    case 'price-desc':
                        return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
                    default:
                        return 0;
                }
            });

            productCards.forEach(card => card.remove());
            productCards.forEach(card => grid.appendChild(card));
        }

        function updateFilterHighlighting() {
            const searchInput = document.getElementById('searchInput');
            const categorySelect = document.getElementById('category');
            const minPriceInput = document.getElementById('minPrice');
            const maxPriceInput = document.getElementById('maxPrice');

            const searchGroup = searchInput.closest('.filter-section');
            if (searchInput.value.trim()) {
                searchGroup.classList.add('filter-active');
            } else {
                searchGroup.classList.remove('filter-active');
            }

            const categoryGroup = categorySelect.closest('.filter-section');
            if (categorySelect.value) {
                categoryGroup.classList.add('filter-active');
            } else {
                categoryGroup.classList.remove('filter-active');
            }

            const minPriceGroup = minPriceInput.closest('.filter-section');
            const maxPriceGroup = maxPriceInput.closest('.filter-section');

            if (minPriceInput.value) {
                minPriceGroup.classList.add('filter-active');
            } else {
                minPriceGroup.classList.remove('filter-active');
            }

            if (maxPriceInput.value) {
                maxPriceGroup.classList.add('filter-active');
            } else {
                maxPriceGroup.classList.remove('filter-active');
            }
        }

        function showNoResultsMessage(searchQuery, visibleCount) {
            const productsGrid = document.querySelector('.products-grid');
            const existingMessage = document.querySelector('.no-results-message');

            if (existingMessage) {
                existingMessage.remove();
            }

            if (visibleCount === 0) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'no-results-message';

                let messageText = 'No products found';
                if (searchQuery) {
                    messageText = `No products found for "${searchQuery}"`;
                }

                messageDiv.innerHTML = `
                    <div class="no-results-content">
                        <i class="fas fa-search"></i>
                        <h3>${messageText}</h3>
                        <p>Try adjusting your search terms or filters</p>
                        <button onclick="clearFilters()" class="clear-search-btn">
                            <i class="fas fa-times"></i>
                            Clear All Filters
                        </button>
                    </div>
                `;

                productsGrid.appendChild(messageDiv);
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('category').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('sortBy').value = 'name-asc';

            document.querySelectorAll('.filter-section').forEach(group => {
                group.classList.remove('filter-active');
            });

            allProductCards.forEach(card => {
                card.style.display = 'block';
            });

            const existingMessage = document.querySelector('.no-results-message');
            if (existingMessage) {
                existingMessage.remove();
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 2700);
        }

        function redirectToLogin() {
            alert('Please login to access this feature');
            window.location.href = '/login';
            return false;
        }

        async function addToCart(productId, size = null) {
            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        productId: productId,
                        size: size,
                        quantity: 1
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const currentCartCount = PersistentStorage.getCartCount();
                    NavbarCounters.updateCartCount(currentCartCount + 1);
                    showNotification('Product added to cart successfully!');
                } else {
                    if (data.message === "User not logged in") {
                        window.location.href = '/login';
                    }
                    showNotification(data.message || 'Error adding product to cart');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showNotification('Error adding product to cart. Please try again.');
            }
        }

        async function toggleWishlist(productId, element) {
            const heartIcon = element.querySelector('i');
            const isCurrentlyInWishlist = PersistentStorage.isInWishlist(productId);

            try {
                const response = await fetch('/wishlist/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId: productId })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.action === 'added') {
                        PersistentStorage.addToWishlist(productId);
                        
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas');
                        heartIcon.style.color = '#ff4757';
                        
                        NavbarCounters.updateWishlistCount();
                        
                        showNotification('Added to wishlist!');
                    } else if (data.action === 'removed') {
                        PersistentStorage.removeFromWishlist(productId);
                        
                        heartIcon.classList.remove('fas');
                        heartIcon.classList.add('far');
                        heartIcon.style.color = '';
                        
                        NavbarCounters.updateWishlistCount();
                        
                        showNotification('Removed from wishlist!');
                    }
                } else {
                    showNotification(data.message || 'Error updating wishlist');
                }
            } catch (error) {
                console.error('Error toggling wishlist:', error);
                showNotification('Error updating wishlist. Please try again.');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            NavbarCounters.init();
            initializeWishlistStates();

            document.getElementById('searchInput').addEventListener('input', function () {
                filterProducts();
            });

            document.getElementById('category').addEventListener('change', function () {
                filterProducts();
            });

            document.getElementById('minPrice').addEventListener('input', function () {
                filterProducts();
            });

            document.getElementById('maxPrice').addEventListener('input', function () {
                filterProducts();
            });

            updateFilterHighlighting();

            setInterval(() => {
                NavbarCounters.init();
            }, 5000);
        });

        window.updateNavbarCartCount = function(newCount) {
            NavbarCounters.updateCartCount(newCount);
        };

        window.updateNavbarWishlistCount = function() {
            NavbarCounters.updateWishlistCount();
        };
    </script>
</body>

</html>
